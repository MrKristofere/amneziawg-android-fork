name: Build and Release APK

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code with submodules
      uses: actions/checkout@v5
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Set up JDK 17
      uses: actions/setup-java@v5
      with:
        distribution: 'temurin'
        java-version: '17'
        cache: 'gradle'

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v4
      with:
        cache-disabled: false
        cache-read-only: false

    - name: Update Android SDK versions
      run: |
        # –û–±–Ω–æ–≤–ª—è–µ–º settings.gradle.kts
        sed -i 's/compileSdk = 35/compileSdk = 36/g' settings.gradle.kts
        sed -i 's/buildToolsVersion = "35.0.0"/buildToolsVersion = "36.0.0"/g' settings.gradle.kts
        
        # –¢–∞–∫–∂–µ –æ–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ build.gradle.kts –≤ –º–æ–¥—É–ª—è—Ö
        find . -name "build.gradle.kts" -type f -exec sed -i 's/compileSdk\s*=.*/compileSdk = 36/g' {} \; || true
        find . -name "build.gradle.kts" -type f -exec sed -i 's/targetSdk\s*=.*/targetSdk = 36/g' {} \; || true
        
        echo "‚úÖ Updated compileSdk to 36"

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      
    - name: Build signed release APK
      run: |
        # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π keystore –¥–ª—è –ø–æ–¥–ø–∏—Å–∏
        keytool -genkeypair \
          -v \
          -keystore temporary.keystore \
          -alias androidkey \
          -keyalg RSA \
          -keysize 2048 \
          -validity 10000 \
          -storepass android \
          -keypass android \
          -dname "CN=Android Debug, O=Android, C=US"
          
        ./gradlew assembleRelease \
          -Pandroid.injected.signing.store.file=$(pwd)/temporary.keystore \
          -Pandroid.injected.signing.store.password=android \
          -Pandroid.injected.signing.key.alias=androidkey \
          -Pandroid.injected.signing.key.password=android

    - name: Find and verify APK
      run: |
        echo "üîç –ü–æ–∏—Å–∫ APK —Ñ–∞–π–ª–æ–≤..."
        find . -name "*.apk" -type f -exec ls -la {} \;
        
        # –ò—â–µ–º release APK
        APK_PATH=$(find . -name "*release*.apk" -type f | head -1)
        if [ -z "$APK_PATH" ]; then
          echo "‚ùå Release APK –Ω–µ –Ω–∞–π–¥–µ–Ω!"
          exit 1
        fi
        
        echo "‚úÖ –ù–∞–π–¥–µ–Ω APK: $APK_PATH"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å—å APK
        echo "üîê –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ APK..."
        apksigner verify --verbose "$APK_PATH" || echo "–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: apksigner –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
        
        # –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º
        mv "$APK_PATH" "amneziawg-android-signed.apk"
        echo "üì¶ APK –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω: amneziawg-android-signed.apk"

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        files: amneziawg-android-signed.apk
        tag_name: v${{ github.run_number }}
        name: AmneziaWG Android v${{ github.run_number }}
        body: |
          ## üì± –ü–æ–¥–ø–∏—Å–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è AmneziaWG Android
          
          **–í–ê–ñ–ù–û**: –≠—Ç–æ—Ç APK –ø–æ–¥–ø–∏—Å–∞–Ω –≤—Ä–µ–º–µ–Ω–Ω—ã–º –∫–ª—é—á–æ–º –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
          
          –î–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ:
          1. –†–∞–∑—Ä–µ—à–∏—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫—É –∏–∑ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
          2. –£–¥–∞–ª–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â—É—é –≤–µ—Ä—Å–∏—é –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
          3. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —ç—Ç–æ—Ç APK
          
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
